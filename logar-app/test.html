<?xml version="1.0" encoding="UTF-8"?>
<html xmlns="http://www.w3.org/1999/xhtml">
    <head>Testing maps</head>
    <script type="text/javascript" src="/exist/apps/logar/resources/js/jquery-1.9.1.min.js"/>
    <style>
        #map{
            width:500px;
            height:400px;
            background-color:#CCC;
        }</style>
    <body onload="initialize();">
        <div id="map"/>
        <button id="loadData">Load Data</button>
        <script type="text/javascript" src="http://maps.googleapis.com/maps/api/js"/>
        <script type="application/javascript">
            var map;
            var places;
            var markers = [];
            var bounds;
            var url; 
            function initialize() {
                 
                 // set some default map details, initial center point, zoom and style
                 var mapOptions = {
                   center: new google.maps.LatLng(0,0),
                   zoom: 7,
                   mapTypeId: google.maps.MapTypeId.ROADMAP
                 };
                 
                 // create the map and reference the div#map-canvas container
                 map = new google.maps.Map(document.getElementById("map"), mapOptions);
                 bounds = new google.maps.LatLngBounds();
                 // fetch the existing places (ajax) 
                 // and put them on the map
                 fetchPlaces('modules/geo-browse.xql');
                 
                // Adjusts zoom for single items on the map
                google.maps.event.addListenerOnce(map, 'bounds_changed', function(event) {
                  if (this.getZoom() &gt; 10) {
                    this.setZoom(10);
                  }
                });
              }
             
             var fetchPlaces = function(url) {
          		var infowindow =  new google.maps.InfoWindow({
          		    content: ''
          		});
          		jQuery.ajax({
          			url : url,
          			dataType : 'json',
          			type : 'get',
                	//data : {
                	//	name : name,
                	//	latlng : lat + "," + lng,
                	//	geo_name : loc_name
                	//},
          			success : function(response) {
          				//if (response.status == 'OK') {
          					places = response;
          					console.log(response);
          					 
          					for(var i = 0, length = places.features.length; i &lt; length; i++) {
          					     var data = places.features[i]
                                 var coords = data.geometry.coordinates;
                                 var latLng = new google.maps.LatLng(coords[1],coords[0]);
                                 var marker = new google.maps.Marker({
                                    position: latLng,
                                    map:map
                                 });
                                 
                                bindInfoWindow(marker, map, infowindow, "&lt;a href='" + data.properties.uri + "'&gt;" + data.properties.name + " - " + data.properties.type + "&lt;/a&gt;");
                                markers.push(marker);
                                
                                // Creating a closure to retain the correct data, notice how I pass the current data in the loop into the closure (marker, data)
         			            (function(marker, data) {
         
                 				// Attaching a click event to the current marker
                 				google.maps.event.addListener(marker, "click", function(e) {
         		         			infoWindow.setContent(data.properties.name);
         				           	infoWindow.open(map, marker);
         				       });
         
         
         			            })(marker, data);
                                bounds.extend(latLng);
                            map.fitBounds(bounds);    
          					}
          			},
          				error: function (request, error) {
                            console.log("Error: " + error);
                        }
          		})
          	};
          	// binds a map marker and infoWindow together on click
          	var bindInfoWindow = function(marker, map, infowindow, html) {
          	    google.maps.event.addListener(marker, 'click', function() {
          	        infowindow.setContent(html);
          	        infowindow.open(map, marker);
          	    });
          	} 
            </script>
    </body>
</html>